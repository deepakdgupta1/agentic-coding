#!/bin/bash
# ACFS Pre-commit Hook: Universal UBS (Ultimate Bug Scanner) Integration
# Works with all agents: Claude Code, Gemini CLI, Antigravity, Codex CLI, AMP
#
# Install: cp .git/hooks/pre-commit.sample .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or: ln -sf ../../.githooks/pre-commit .git/hooks/pre-commit

# Check if ubs is available
if ! command -v ubs &>/dev/null; then
    echo "‚ö†Ô∏è  UBS (Ultimate Bug Scanner) not found in PATH - skipping pre-commit scan"
    echo "   Install: curl -sSL https://raw.githubusercontent.com/Dicklesworthstone/ultimate_bug_scanner/master/install.sh | bash"
    exit 0
fi

# Get staged files that UBS can scan
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx|mjs|cjs|py|pyw|pyi|c|cc|cpp|cxx|h|hh|hpp|hxx|rs|go|java|rb)$')

if [ -z "$STAGED_FILES" ]; then
    # No scannable files staged
    exit 0
fi

echo "üî¨ Running UBS on staged files..."
echo "$STAGED_FILES" | xargs ubs --ci

EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "‚ùå UBS found issues in staged files. Fix them before committing."
    echo "   Run: ubs <file> to scan specific files"
    echo "   Bypass (not recommended): git commit --no-verify"
    exit 1
fi

echo "‚úÖ UBS scan passed"
exit 0
